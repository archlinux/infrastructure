- name: Ensure latest keyring
  pacman:
    name: archlinux-keyring
    state: latest
    update_cache: yes

- name: Upgrade all packages
  pacman:
    upgrade: yes
  register: pacman_upgrade

- name: Stop if no packages were upgraded
  meta: end_host
  when: pacman_upgrade is not changed

- name: Check for running builds
  block:
    - name: List build-related processes
      command: pgrep -x 'mkarchroot|makechrootpkg|systemd-nspawn'
      register: pgrep
      ignore_errors: true

    - name: Abort reboot with running builds
      meta: end_host
      when: pgrep is succeeded
  when: "'buildservers' in group_names"


- name: Check for active borg backup jobs
  block:
    - name: Check if /backup exists
      stat: path=/backup
      register: backup_mountdir

    - name: Abort reboot when borg backup is running
      meta: end_host
      when: backup_mountdir.stat.exists
  when: "'borg_clients' in group_names"

- name: Gemini pre-reboot checks
  block:
    - name: List logged on users
      command: who
      register: who

    - name: Abort reboot with logged on users
      meta: end_host
      when:
        - who is changed
        - who.stdout_lines|length > 1

    - name: Stop arch-svntogit.timer
      service: name=arch-svntogit.timer state=stopped

    - name: Wait for svntogit to finish
      wait_for:
        path: /srv/svntogit/update-repos.sh.lock
        state: absent
  when: inventory_hostname == "gemini.archlinux.org"

- name: Reboot
  reboot:
