limit_req_zone $binary_remote_addr zone={{ http_redirect_ratelimit_zone }}:10m rate=20r/s;
server {
    include snippets/listen-80.conf;

    server_name  {{ domain }};

    access_log   /var/log/nginx/{{ domain }}/access.log main;
    access_log   /var/log/nginx/{{ domain }}/access.log.json json_main;
    error_log    /var/log/nginx/{{ domain }}/error.log;

    include snippets/letsencrypt.conf;

    location / {
        limit_req zone=httpredirectlimit burst=10 nodelay;
        # this try_files statement allows the limit_req to be enforced before the redirect.
    	try_files "" @https_redirect;
    }

    location @https_redirect {
        return 301 https://$server_name$request_uri;
    }
}
