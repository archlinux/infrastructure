- name: Create ssl cert
  include_role:
    name: certificate
  vars:
    domains: ["{{ riscv_mirror_domain }}"]
    challenge: "DNS-01"

- name: Install rsync
  pacman: name=rsync state=present

- name: Install syncriscv script
  copy: src=syncriscv dest=/usr/local/bin/syncriscv owner=root group=root mode=0755

- name: Install syncriscv units
  copy: src={{ item }} dest=/etc/systemd/system/{{ item }} owner=root group=root mode=0644
  with_items:
    - syncriscv.timer
    - syncriscv.service

- name: Start and enable syncriscv timer
  systemd: name=syncriscv.timer enabled=yes state=started daemon_reload=yes

- name: Set up nginx
  template: src=nginx.d.conf.j2 dest=/etc/nginx/nginx.d/riscv.conf owner=root group=root mode=0644
  notify: Reload nginx
  tags: ['nginx']

- name: Make nginx log dir
  file: path=/var/log/nginx/{{ riscv_mirror_domain }} state=directory owner=root group=root mode=0755
